@page
@model BankApplication.Pages.AccountTransactionsModel
@{
    ViewData["Title"] = "Account Transactions";
    Layout = "_DashboardLayout";
}

<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0">Account number: @Model.Account.AccountId</h2>
    </div>
    <div class="card-body">
        <p><strong>Saldo:</strong> @Model.Account.Balance.ToString("C")</p>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Transactions</h5>
    </div>
    <div class="card-body">
        <table class="table table-striped" id="transactionTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Operation</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.Transactions)
                {
                    <tr>
                        <td>@t.Date.ToString("yyyy-MM-dd HH:mm:ss")</td>

                        <td>@t.Type</td>
                        <td>@t.Operation</td>
                        <td class="@t.CssClass">@t.DisplayAmount</td>
                    </tr>
                }

            </tbody>
        </table>

        @if (Model.Transactions.Count == Model.PageSize)
        {
            <div class="text-center">
                <button id="loadMoreBtn" class="btn btn-primary" data-skip="@Model.PageSize">
                    Show more
                </button>
            </div>
        }

        <div id="loadingSpinner" class="text-center mt-3" style="display:none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>
<div class="text-end mt-4">
    <button onclick="scrollToTop()" id="scrollTopBtn" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-up"></i>
    </button>
</div>

<div class="mt-2">
    <button onclick="history.back()" id="backPrevBtnWithText" class="btn btn-outline-dark">
        <i class="fas fa-arrow-left me-1"></i> Back to previous page
    </button>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script>
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.addEventListener('scroll', function () {
            var btn = document.getElementById('scrollTopBtn');
            if (window.scrollY > 300) {
                btn.style.display = 'inline-block';
            } else {
                btn.style.display = 'none';
            }
        });

        document.getElementById('loadMoreBtn')?.addEventListener('click', function () {
            let skip = parseInt(this.getAttribute('data-skip'));
            let accountId = "@Model.Account.AccountId";

            document.getElementById('loadingSpinner').style.display = 'block';

            fetch(`/AccountTransactions?handler=LoadMore&accountId=${accountId}&skip=${skip}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.querySelector('#transactionTable tbody');
                    data.transactions.forEach(t => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(t.date).toLocaleDateString()}</td>
                            <td>${t.type}</td>
                            <td>${t.operation}</td>
                            <td>${t.amount.toLocaleString('sv-SE', { style: 'currency', currency: 'SEK' })}</td>
                        `;
                        tbody.appendChild(row);
                    });

                    if (!data.hasMore) {
                        document.getElementById('loadMoreBtn').style.display = 'none';
                    } else {
                        document.getElementById('loadMoreBtn').setAttribute('data-skip', skip + 20);
                    }
                })
                .catch(error => console.error('Error:', error))
                .finally(() => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        });
    </script>
}
